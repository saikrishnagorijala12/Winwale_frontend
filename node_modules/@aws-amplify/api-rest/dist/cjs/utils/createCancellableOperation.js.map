{"version":3,"file":"createCancellableOperation.js","sources":["../../../src/utils/createCancellableOperation.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.createCancellableOperation = createCancellableOperation;\nconst errors_1 = require(\"../errors\");\nconst serviceError_1 = require(\"./serviceError\");\nconst logger_1 = require(\"./logger\");\n/**\n * @internal\n */\nfunction createCancellableOperation(handler, abortController, operationType, timeout) {\n    const abortSignal = abortController.signal;\n    let abortReason;\n    if (timeout != null) {\n        if (timeout < 0) {\n            throw new Error('Timeout must be a non-negative number');\n        }\n        setTimeout(() => {\n            abortReason = 'TimeoutError';\n            abortController.abort(abortReason);\n        }, timeout);\n    }\n    const job = async () => {\n        try {\n            const response = await handler();\n            if (response.statusCode >= 300) {\n                throw await (0, serviceError_1.parseRestApiServiceError)(response);\n            }\n            return response;\n        }\n        catch (error) {\n            if (error.name === 'AbortError' || abortSignal?.aborted === true) {\n                // Check if timeout caused the abort\n                const isTimeout = abortReason && abortReason === 'TimeoutError';\n                if (isTimeout) {\n                    const timeoutError = new Error(`Request timeout after ${timeout}ms`);\n                    timeoutError.name = 'TimeoutError';\n                    logger_1.logger.debug(timeoutError);\n                    throw timeoutError;\n                }\n                else {\n                    const message = abortReason ?? abortSignal.reason;\n                    const canceledError = new errors_1.CanceledError({\n                        ...(message && { message }),\n                        underlyingError: error,\n                        recoverySuggestion: 'The API request was explicitly canceled. If this is not intended, validate if you called the `cancel()` function on the API request erroneously.',\n                    });\n                    logger_1.logger.debug(canceledError);\n                    throw canceledError;\n                }\n            }\n            logger_1.logger.debug(error);\n            throw error;\n        }\n    };\n    if (operationType === 'internal') {\n        return job();\n    }\n    else {\n        const cancel = (abortMessage) => {\n            if (abortSignal.aborted === true) {\n                return;\n            }\n            abortController.abort(abortMessage);\n            // If abort reason is not supported, set a scoped reasons instead. The reason property inside an\n            // AbortSignal is a readonly property and trying to set it would throw an error.\n            if (abortMessage && abortSignal.reason !== abortMessage) {\n                abortReason = abortMessage;\n            }\n        };\n        return { response: job(), cancel };\n    }\n}\n"],"names":[],"mappings":"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"}